    pe.actor_id as actor_id,\n            pe.section_subsection_problem_engagement\n            as section_subsection_problem_engagement,\n            users.username as username,\n            users.name as name,\n            users.email as email\n        from problem_engagement pe\n        join\n            reporting.dim_course_blocks course_blocks\n            on (\n                pe.org = course_blocks.org\n                and pe.course_key = course_blocks.course_key\n                and pe.block_id = course_blocks.block_id\n            )\n        left outer join\n            reporting.dim_user_pii users\n            on (pe.actor_id like \'mailto:%\' and SUBSTRING(pe.actor_id, 8) = users.email)\n            or pe.actor_id = toString(users.external_user_id)\n        where\n            1 = 1\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                        )\n                )\n            {% endif %}\n    )\nselect fact_problem_engagement.*\nfrom fact_problem_engagement pe\njoin\n    (\n        with\n            page_visits as (\n                select org, course_key, actor_id, max(emission_time) as last_visited\n                from xapi.fact_learner_last_course_visit\n                where\n                    1 = 1\n                    {% if filter_values(\"org\") != [] %}\n                        and org in {{ filter_values(\"org\") | where_in }}\n                    {% endif %}\n\n                    {% if filter_values(\"course_name\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from event_sink.course_names\n                            where\n                                course_name\n                                in {{ filter_values(\"course_name\") | where_in }}\n                        )\n                    {% endif %}\n\n                    {% if filter_values(\"tag\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from reporting.most_recent_course_tags\n                            where\n                                tag in (\n                                    select\n                                        replaceAll(\n                                            arrayJoin({{ filter_values(\"tag\") }}),\n                                            \'- \',\n                                            \'\'\n                                        )\n                                )\n                        )\n                    {% endif %}\n                    and emission_time < subtractDays(now(), 7)\n                group by org, course_key, actor_id\n            )\n\n        select org, course_key, learners.actor_id as actor_id\n        from reporting.fact_student_status learners\n        join page_visits using (org, course_key, actor_id)\n        where\n            approving_state = \'failed\' and enrollment_status = \'registered\'\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                        )\n                )\n            {% endif %}\n    ) as at_risk_learners\n    on (\n        pe.org = at_risk_learners.org\n        and pe.course_key = at_risk_learners.course_key\n        and pe.actor_id = at_risk_learners.actor_id\n    )\n',NULL,'[OpenedX Clickhouse].[fact_at_risk_problem_engagement_he](id:417)',0,NULL,0,'{}','[OpenedX Clickhouse].[reporting]',NULL,_binary 'û›[þ«ú\æwi\ZA',0,NULL,1,0),('2025-01-10 06:45:25','2025-01-14 07:52:58',418,'fact_video_watches_fr_CA',NULL,NULL,1,1,1,0,NULL,0,NULL,'reporting','with\n    watched_segments as (\n        with\n            video_events as (\n                select\n                    emission_time,\n                    org,\n                    course_key,\n                    splitByString(\'/xblock/\', object_id)[-1] as video_id,\n                    object_id,\n                    actor_id,\n                    verb_id,\n                    video_position,\n                    video_duration\n                from xapi.video_playback_events\n                where\n                    1 = 1\n                    {% if filter_values(\"org\") != [] %}\n                        and org in {{ filter_values(\"org\") | where_in }}\n                    {% endif %}\n\n                    {% if filter_values(\"course_name\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from event_sink.course_names\n                            where\n                                course_name\n                                in {{ filter_values(\"course_name\") | where_in }}\n                        )\n                    {% endif %}\n\n                    {% if filter_values(\"tag\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from reporting.most_recent_course_tags\n                            where\n                                tag in (\n                                    select\n                                        replaceAll(\n                                            arrayJoin({{ filter_values(\"tag\") }}),\n                                            \'- \',\n                                            \'\'\n                                        )\n                                )\n                        )\n                    {% endif %}\n            ),\n            starts as (\n                select *\n                from video_events\n                where verb_id = \'https://w3id.org/xapi/video/verbs/played\'\n            ),\n            ends as (\n                select *\n                from video_events\n                where\n                    verb_id in (\n                        \'http://adlnet.gov/expapi/verbs/completed\',\n                        \'https://w3id.org/xapi/video/verbs/seeked\',\n                        \'https://w3id.org/xapi/video/verbs/paused\',\n                        \'http://adlnet.gov/expapi/verbs/terminated\'\n                    )\n            ),\n            segments as (\n                select\n                    starts.org as org,\n                    starts.course_key as course_key,\n                    starts.video_id as video_id,\n                    starts.actor_id,\n                    starts.object_id as object_id,\n                    cast(starts.video_position as Int32) as start_position,\n                    cast(ends.video_position as Int32) as end_position,\n                    starts.emission_time as started_at,\n                    ends.emission_time as ended_at,\n                    ends.verb_id as end_type,\n                    starts.video_duration as video_duration\n                from starts left\n                asof join\n                    ends\n                    on (\n                        starts.org = ends.org\n                        and starts.course_key = ends.course_key\n                        and starts.video_id = ends.video_id\n                        and starts.actor_id = ends.actor_id\n                        and starts.emission_time < ends.emission_time\n                    )\n            ),\n            enriched_segments as (\n                select\n                    segments.org as org,\n                    segments.course_key as course_key,\n                    blocks.course_name as course_name,\n                    blocks.course_run as course_run,\n                    blocks.section_with_name as section_with_name,\n                    blocks.subsection_with_name as subsection_with_name,\n                    blocks.block_name as video_name,\n                    blocks.display_name_with_location as video_name_with_location,\n                    segments.actor_id as actor_id,\n                    segments.object_id as object_id,\n                    segments.started_at as started_at,\n                    segments.start_position\n                    - (segments.start_position % 5) as start_position,\n                    segments.end_position - (segments.end_position % 5) as end_position,\n                    segments.video_duration as video_duration,\n                    segments.video_id as video_id\n                from segments\n                join\n                    reporting.dim_course_blocks_extended blocks\n                    on (\n                        segments.course_key = blocks.course_key\n                        and segments.video_id = blocks.block_id\n                    )\n                where\n                    1 = 1\n                    {% if filter_values(\"org\") != [] %}\n                        and org in {{ filter_values(\"org\") | where_in }}\n                    {% endif %}\n\n                    {% if filter_values(\"course_name\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from event_sink.course_names\n                            where\n                                course_name\n                                in {{ filter_values(\"course_name\") | where_in }}\n                        )\n                    {% endif %}\n\n                    {% if filter_values(\"tag\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from reporting.most_recent_course_tags\n                            where\n                                tag in (\n                                    select\n                                        replaceAll(\n                                            arrayJoin({{ filter_values(\"tag\") }}),\n                                            \'- \',\n                                            \'\'\n                                        )\n                                )\n                        )\n                    {% endif %}\n            )\n\n        select\n            org,\n            course_key,\n            course_name,\n            course_run,\n            section_with_name,\n            subsection_with_name,\n            video_name,\n            video_name_with_location,\n            video_id,\n            concat(\n                \'<a href=\"\',\n                object_id,\n                \'\" target=\"_blank\">\',\n                video_name_with_location,\n                \'</a>\'\n            ) as video_link,\n            actor_id,\n            started_at,\n            arrayJoin(range(start_position, end_position, 5)) as segment_start,\n            video_duration,\n            CONCAT(\n                toString(segment_start), \'-\', toString(segment_start + 4)\n            ) as segment_range,\n            start_position,\n            username,\n            name,\n            email\n        from enriched_segments\n        left outer join\n            reporting.dim_user_pii users\n            on (actor_id like \'mailto:%\' and SUBSTRING(actor_id, 8) = users.email)\n            or actor_id = toString(users.external_user_id)\n        order by segment_start\n    )\n\nselect\n    org,\n    course_key,\n    course_name,\n    course_run,\n    section_with_name,\n    subsection_with_name,\n    video_name,\n    video_name_with_location,\n    video_link,\n    actor_id,\n    username,\n    email,\n    name,\n    count(distinct segment_start) as watched_segment_count,\n    (video_duration - 10) / 5 as video_segment_count,\n    video_segment_count <= watched_segment_count as watched_entire_video\nfrom watched_segments\nwhere\n    1 = 1\n\n    {% if filter_values(\"Section Name\") != [] %}\n        and section_with_name in {{ filter_values(\"Section Name\") | where_in }}\n    {% endif %}\n    {% if filter_values(\"Subsection Name\") != [] %}\n        and subsection_with_name in {{ filter_values(\"Subsection Name\") | where_in }}\n    {% endif %}\n    {% if from_dttm %} and started_at > \'{{ from_dttm }}\' {% endif %}\n    {% if to_dttm %} and started_at < \'{{ to_dttm }}\' {% endif %}\n\ngroup by\n    org,\n    course_key,\n    course_name,\n    course_run,\n    section_with_name,\n    subsection_with_name,\n    video_name,\n    video_name_with_location,\n    video_link,\n    actor_id,\n    video_id,\n    video_segment_count,\n    username,\n    email,\n    name\n',NULL,'[OpenedX Clickhouse].[fact_video_watches_fr_CA](id:418)',0,NULL,0,NULL,'[OpenedX Clickhouse].[reporting]','{}',_binary '\Ý|ƒ{j[}€4§	Jn',0,NULL,1,0),('2025-01-10 06:45:25','2025-01-14 07:52:58',419,'query_log_de_DE',NULL,NULL,1,1,1,0,NULL,0,NULL,'system','select\n    query_duration_ms,\n    result_rows,\n    memory_usage / (1024 * 1024) as memory_usage_mb,\n    event_time,\n    tables,\n    query,\n    http_user_agent\nfrom system.query_log\nwhere\n    (\n        has(databases, \'xapi\')\n        or has(databases, \'event_sink\')\n        or has(databases, \'reporting\')\n    )\n    and (http_user_agent like \'aspects-%\')\n    and (type = \'QueryFinish\')\norder by event_time DESC\n',NULL,'[OpenedX Clickhouse].[query_log_de_DE](id:419)',1,NULL,0,NULL,'[OpenedX Clickhouse].[system]',NULL,_binary '.\Ë\ZR¢þ^\â\ÑGp\éþ8',0,NULL,0,0),('2025-01-10 06:45:25','2025-01-14 07:52:58',420,'fact_at_risk_video_engagement_ar',NULL,NULL,1,1,1,0,NULL,0,NULL,'reporting','select fact_video_engagement.*\nfrom reporting.fact_video_engagement\njoin\n    (\n        with\n            page_visits as (\n                select org, course_key, actor_id, max(emission_time) as last_visited\n                from xapi.fact_learner_last_course_visit\n                where\n                    1 = 1\n                    {% if filter_values(\"org\") != [] %}\n                        and org in {{ filter_values(\"org\") | where_in }}\n                    {% endif %}\n\n                    {% if filter_values(\"course_name\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from event_sink.course_names\n                            where\n                                course_name\n                                in {{ filter_values(\"course_name\") | where_in }}\n                        )\n                    {% endif %}\n\n                    {% if filter_values(\"tag\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from reporting.most_recent_course_tags\n                            where\n                                tag in (\n                                    select\n                                        replaceAll(\n                                            arrayJoin({{ filter_values(\"tag\") }}),\n                                            \'- \',\n                                            \'\'\n                                        )\n                                )\n                        )\n                    {% endif %}\n                    and emission_time < subtractDays(now(), 7)\n                group by org, course_key, actor_id\n            )\n\n        select org, course_key, learners.actor_id as actor_id\n        from reporting.fact_student_status learners\n        join page_visits using (org, course_key, actor_id)\n        where\n            approving_state = \'failed\' and enrollment_status = \'registered\'\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                        )\n                )\n            {% endif %}\n    ) as at_risk_learners using (org, course_key, actor_id)\nwhere\n    1 = 1\n    {% if filter_values(\"org\") != [] %}\n        and org in {{ filter_values(\"org\") | where_in }}\n    {% endif %}\n\n    {% if filter_values(\"course_name\") != [] %}\n        and course_key in (\n            select course_key\n            from event_sink.course_names\n            where course_name in {{ filter_values(\"course_name\") | where_in }}\n        )\n    {% endif %}\n\n    {% if filter_values(\"tag\") != [] %}\n        and course_key in (\n            select course_key\n            from reporting.most_recent_course_tags\n            where\n                tag\n                in (select replaceAll(arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'))\n        )\n    {% endif %}\n',NULL,'[OpenedX Clickhouse].[fact_at_risk_video_engagement_ar](id:420)',0,NULL,0,'{}','[OpenedX Clickhouse].[reporting]',NULL,_binary 'Á½Ò—ˆûQk¿\"@6³(9\Æ',0,NULL,1,0),('2025-01-10 06:45:25','2025-01-14 07:52:58',421,'fact_student_status_he','enrolled_at',NULL,1,1,1,0,NULL,0,NULL,'reporting','select * from reporting.fact_student_status\n',NULL,'[OpenedX Clickhouse].[fact_student_status_he](id:421)',1,NULL,0,NULL,'[OpenedX Clickhouse].[reporting]',NULL,_binary '\"?WhV»\ë´q\Ýi',0,NULL,0,0),('2025-01-10 06:45:25','2025-01-14 07:52:59',422,'fact_at_risk_video_engagement',NULL,NULL,1,1,1,0,NULL,0,NULL,'reporting','select fact_video_engagement.*\nfrom reporting.fact_video_engagement\njoin\n    (\n        with\n            page_visits as (\n                select org, course_key, actor_id, max(emission_time) as last_visited\n                from xapi.fact_learner_last_course_visit\n                where\n                    1 = 1\n                    {% if filter_values(\"org\") != [] %}\n                        and org in {{ filter_values(\"org\") | where_in }}\n                    {% endif %}\n\n                    {% if filter_values(\"course_name\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from event_sink.course_names\n                            where\n                                course_name\n                                in {{ filter_values(\"course_name\") | where_in }}\n                        )\n                    {% endif %}\n\n                    {% if filter_values(\"tag\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from reporting.most_recent_course_tags\n                            where\n                                tag in (\n                                    select\n                                        replaceAll(\n                                            arrayJoin({{ filter_values(\"tag\") }}),\n                                            \'- \',\n                                            \'\'\n                                        )\n                                )\n                        )\n                    {% endif %}\n                    and emission_time < subtractDays(now(), 7)\n                group by org, course_key, actor_id\n            )\n\n        select org, course_key, learners.actor_id as actor_id\n        from reporting.fact_student_status learners\n        join page_visits using (org, course_key, actor_id)\n        where\n            approving_state = \'failed\' and enrollment_status = \'registered\'\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                        )\n                )\n            {% endif %}\n    ) as at_risk_learners using (org, course_key, actor_id)\nwhere\n    1 = 1\n    {% if filter_values(\"org\") != [] %}\n        and org in {{ filter_values(\"org\") | where_in }}\n    {% endif %}\n\n    {% if filter_values(\"course_name\") != [] %}\n        and course_key in (\n            select course_key\n            from event_sink.course_names\n            where course_name in {{ filter_values(\"course_name\") | where_in }}\n        )\n    {% endif %}\n\n    {% if filter_values(\"tag\") != [] %}\n        and course_key in (\n            select course_key\n            from reporting.most_recent_course_tags\n            where\n                tag\n                in (select replaceAll(arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'))\n        )\n    {% endif %}\n',NULL,'[OpenedX Clickhouse].[fact_at_risk_video_engagement](id:422)',0,NULL,0,'{}','[OpenedX Clickhouse].[reporting]',NULL,_binary 'ÏŸ\ã¦\÷£IQ¦i\ØÃ„_M%',0,NULL,1,0),('2025-01-10 06:45:26','2025-01-14 07:52:59',423,'fact_at_risk_video_watches_it_IT',NULL,NULL,1,1,1,0,NULL,0,NULL,'reporting','with\n    watches as (\n        with\n            watched_segments as (\n                with\n                    video_events as (\n                        select\n                            emission_time,\n                            org,\n                            course_key,\n                            splitByString(\'/xblock/\', object_id)[-1] as video_id,\n                            object_id,\n                            actor_id,\n                            verb_id,\n                            video_position,\n                            video_duration\n                        from xapi.video_playback_events\n                        where\n                            1 = 1\n                            {% if filter_values(\"org\") != [] %}\n                                and org in {{ filter_values(\"org\") | where_in }}\n                            {% endif %}\n\n                            {% if filter_values(\"course_name\") != [] %}\n                                and course_key in (\n                                    select course_key\n                                    from event_sink.course_names\n                                    where\n                                        course_name\n                                        in {{ filter_values(\"course_name\") | where_in }}\n                                )\n                            {% endif %}\n\n                            {% if filter_values(\"tag\") != [] %}\n                                and course_key in (\n                                    select course_key\n                                    from reporting.most_recent_course_tags\n                                    where\n                                        tag in (\n                                            select\n                                                replaceAll(\n                                                    arrayJoin(\n                                                        {{ filter_values(\"tag\") }}\n                                                    ),\n                                                    \'- \',\n                                                    \'\'\n                                                )\n                                        )\n                                )\n                            {% endif %}\n                    ),\n                    starts as (\n                        select *\n                        from video_events\n                        where verb_id = \'https://w3id.org/xapi/video/verbs/played\'\n                    ),\n                    ends as (\n                        select *\n                        from video_events\n                        where\n                            verb_id in (\n                                \'http://adlnet.gov/expapi/verbs/completed\',\n                                \'https://w3id.org/xapi/video/verbs/seeked\',\n                                \'https://w3id.org/xapi/video/verbs/paused\',\n                                \'http://adlnet.gov/expapi/verbs/terminated\'\n                            )\n                    ),\n                    segments as (\n                        select\n                            starts.org as org,\n                            starts.course_key as course_key,\n                            starts.video_id as video_id,\n                            starts.actor_id,\n                            starts.object_id as object_id,\n                            cast(starts.video_position as Int32) as start_position,\n                            cast(ends.video_position as Int32) as end_position,\n                            starts.emission_time as started_at,\n                            ends.emission_time as ended_at,\n                            ends.verb_id as end_type,\n                            starts.video_duration as video_duration\n                        from starts left\n                        asof join\n                            ends\n                            on (\n                                starts.org = ends.org\n                                and starts.course_key = ends.course_key\n                                and starts.video_id = ends.video_id\n                                and starts.actor_id = ends.actor_id\n                                and starts.emission_time < ends.emission_time\n                            )\n                    ),\n                    enriched_segments as (\n                        select\n                            segments.org as org,\n                            segments.course_key as course_key,\n                            blocks.course_name as course_name,\n                            blocks.course_run as course_run,\n                            blocks.section_with_name as section_with_name,\n                            blocks.subsection_with_name as subsection_with_name,\n                            blocks.block_name as video_name,\n                            blocks.display_name_with_location\n                            as video_name_with_location,\n                            segments.actor_id as actor_id,\n                            segments.object_id as object_id,\n                            segments.started_at as started_at,\n                            segments.start_position\n                            - (segments.start_position % 5) as start_position,\n                            segments.end_position\n                            - (segments.end_position % 5) as end_position,\n                            segments.video_duration as video_duration,\n                            segments.video_id as video_id\n                        from segments\n                        join\n                            reporting.dim_course_blocks_extended blocks\n                            on (\n                                segments.course_key = blocks.course_key\n                                and segments.video_id = blocks.block_id\n                            )\n                        where\n                            1 = 1\n                            {% if filter_values(\"org\") != [] %}\n                                and org in {{ filter_values(\"org\") | where_in }}\n                            {% endif %}\n\n                            {% if filter_values(\"course_name\") != [] %}\n                                and course_key in (\n                                    select course_key\n                                    from event_sink.course_names\n                                    where\n                                        course_name\n                                        in {{ filter_values(\"course_name\") | where_in }}\n                                )\n                            {% endif %}\n\n                            {% if filter_values(\"tag\") != [] %}\n                                and course_key in (\n                                    select course_key\n                                    from reporting.most_recent_course_tags\n                                    where\n                                        tag in (\n                                            select\n                                                replaceAll(\n                                                    arrayJoin(\n                                                        {{ filter_values(\"tag\") }}\n                                                    ),\n                                                    \'- \',\n                                                    \'\'\n                                                )\n                                        )\n                                )\n                            {% endif %}\n                    )\n\n                select\n                    org,\n                    course_key,\n                    course_name,\n                    course_run,\n                    section_with_name,\n                    subsection_with_name,\n                    video_name,\n                    video_name_with_location,\n                    video_id,\n                    concat(\n                        \'<a href=\"\',\n                        object_id,\n                        \'\" target=\"_blank\">\',\n                        video_name_with_location,\n                        \'</a>\'\n                    ) as video_link,\n                    actor_id,\n                    started_at,\n                    arrayJoin(range(start_position, end_position, 5)) as segment_start,\n                    video_duration,\n                    CONCAT(\n                        toString(segment_start), \'-\', toString(segment_start + 4)\n                    ) as segment_range,\n                    start_position,\n                    username,\n                    name,\n                    email\n                from enriched_segments\n                left outer join\n                    reporting.dim_user_pii users\n                    on (\n                        actor_id like \'mailto:%\'\n                        and SUBSTRING(actor_id, 8) = users.email\n                    )\n                    or actor_id = toString(users.external_user_id)\n                order by segment_start\n            )\n\n        select\n            org,\n            course_key,\n            course_name,\n            course_run,\n            section_with_name,\n            subsection_with_name,\n            video_name,\n            video_name_with_location,\n            video_link,\n            actor_id,\n            username,\n            email,\n            name,\n            count(distinct segment_start) as watched_segment_count,\n            (video_duration - 10) / 5 as video_segment_count,\n            video_segment_count <= watched_segment_count as watched_entire_video\n        from watched_segments\n        where\n            1 = 1\n\n            {% if filter_values(\"Section Name\") != [] %}\n                and section_with_name in {{ filter_values(\"Section Name\") | where_in }}\n            {% endif %}\n            {% if filter_values(\"Subsection Name\") != [] %}\n                and subsection_with_name\n                in {{ filter_values(\"Subsection Name\") | where_in }}\n            {% endif %}\n            {% if from_dttm %} and started_at > \'{{ from_dttm }}\' {% endif %}\n            {% if to_dttm %} and started_at < \'{{ to_dttm }}\' {% endif %}\n\n        group by\n            org,\n            course_key,\n            course_name,\n            course_run,\n            section_with_name,\n            subsection_with_name,\n            video_name,\n            video_name_with_location,\n            video_link,\n            actor_id,\n            video_id,\n            video_segment_count,\n            username,\n            email,\n            name\n    )\n\nselect watches.*\nfrom watches\njoin\n    (\n        with\n            page_visits as (\n                select org, course_key, actor_id, max(emission_time) as last_visited\n                from xapi.fact_learner_last_course_visit\n                where\n                    1 = 1\n                    {% if filter_values(\"org\") != [] %}\n                        and org in {{ filter_values(\"org\") | where_in }}\n                    {% endif %}\n\n                    {% if filter_values(\"course_name\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from event_sink.course_names\n                            where\n                                course_name\n                                in {{ filter_values(\"course_name\") | where_in }}\n                        )\n                    {% endif %}\n\n                    {% if filter_values(\"tag\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from reporting.most_recent_course_tags\n                            where\n                                tag in (\n                                    select\n                                        replaceAll(\n                                            arrayJoin({{ filter_values(\"tag\") }}),\n                                            \'- \',\n                                            \'\'\n                                        )\n                                )\n                        )\n                    {% endif %}\n                    and emission_time < subtractDays(now(), 7)\n                group by org, course_key, actor_id\n            )\n\n        select org, course_key, learners.actor_id as actor_id\n        from reporting.fact_student_status learners\n        join page_visits using (org, course_key, actor_id)\n        where\n            approving_state = \'failed\' and enrollment_status = \'registered\'\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                        )\n                )\n            {% endif %}\n    ) as at_risk_learners using (org, course_key, actor_id)\nwhere\n    1 = 1\n    {% if filter_values(\"org\") != [] %}\n        and org in {{ filter_values(\"org\") | where_in }}\n    {% endif %}\n\n    {% if filter_values(\"course_name\") != [] %}\n        and course_key in (\n            select course_key\n            from event_sink.course_names\n            where course_name in {{ filter_values(\"course_name\") | where_in }}\n        )\n    {% endif %}\n\n    {% if filter_values(\"tag\") != [] %}\n        and course_key in (\n            select course_key\n            from reporting.most_recent_course_tags\n            where\n                tag\n                in (select replaceAll(arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'))\n        )\n    {% endif %}\n',NULL,'[OpenedX Clickhouse].[fact_at_risk_video_watches_it_IT](id:423)',0,NULL,0,NULL,'[OpenedX Clickhouse].[reporting]','{}',_binary 'oIE\Ê\ÄIZ\öB/‹™¢',0,NULL,1,0),('2025-01-10 06:45:26','2025-01-14 07:52:59',424,'fact_pageview_engagement_pt_BR',NULL,NULL,1,1,1,0,NULL,0,NULL,'reporting','with\n    subsection_engagement as (\n        select\n            org,\n            course_key,\n            \'subsection\' as content_level,\n            actor_id,\n            subsection_block_id as block_id,\n            engagement_level as section_subsection_page_engagement\n        from xapi.subsection_page_engagement\n        where\n            1 = 1\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                        )\n                )\n            {% endif %}\n    ),\n    section_engagement as (\n        select\n            org,\n            course_key,\n            \'section\' as content_level,\n            actor_id,\n            section_block_id as block_id,\n            engagement_level as section_subsection_page_engagement\n        from xapi.section_page_engagement\n    ),\n    page_engagement as (\n        select *\n        from subsection_engagement\n        union all\n        select *\n        from section_engagement\n    )\n\nselect\n    pv.org as org,\n    pv.course_key as course_key,\n    course_blocks.course_run as course_run,\n    course_blocks.display_name_with_location as section_subsection_name,\n    pv.content_level as content_level,\n    pv.actor_id as actor_id,\n    pv.section_subsection_page_engagement as section_subsection_page_engagement,\n    users.username as username,\n    users.name as name,\n    users.email as email\nfrom page_engagement pv\njoin\n    reporting.dim_course_blocks course_blocks\n    on (\n        pv.org = course_blocks.org\n        and pv.course_key = course_blocks.course_key\n        and pv.block_id = course_blocks.block_id\n    )\nleft outer join\n    reporting.dim_user_pii users\n    on (pv.actor_id like \'mailto:%\' and SUBSTRING(pv.actor_id, 8) = users.email)\n    or pv.actor_id = toString(users.external_user_id)\nwhere\n    1 = 1\n    {% if filter_values(\"org\") != [] %}\n        and org in {{ filter_values(\"org\") | where_in }}\n    {% endif %}\n\n    {% if filter_values(\"course_name\") != [] %}\n        and course_key in (\n            select course_key\n            from event_sink.course_names\n            where course_name in {{ filter_values(\"course_name\") | where_in }}\n        )\n    {% endif %}\n\n    {% if filter_values(\"tag\") != [] %}\n        and course_key in (\n            select course_key\n            from reporting.most_recent_course_tags\n            where\n                tag\n                in (select replaceAll(arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'))\n        )\n    {% endif %}\n',NULL,'[OpenedX Clickhouse].[fact_pageview_engagement_pt_BR](id:424)',0,NULL,0,'{}','[OpenedX Clickhouse].[reporting]',NULL,_binary 'ž\\uS‰°ƒzr°\Ñ',0,NULL,1,0),('2025-01-10 06:45:26','2025-01-14 07:52:59',425,'fact_video_watches_tr_TR',NULL,NULL,1,1,1,0,NULL,0,NULL,'reporting','with\n    watched_segments as (\n        with\n            video_events as (\n                select\n                    emission_time,\n                    org,\n                    course_key,\n                    splitByString(\'/xblock/\', object_id)[-1] as video_id,\n                    object_id,\n                    actor_id,\n                    verb_id,\n                    video_position,\n                    video_duration\n                from xapi.video_playback_events\n                where\n                    1 = 1\n                    {% if filter_values(\"org\") != [] %}\n                        and org in {{ filter_values(\"org\") | where_in }}\n                    {% endif %}\n\n                    {% if filter_values(\"course_name\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from event_sink.course_names\n                            where\n                                course_name\n                                in {{ filter_values(\"course_name\") | where_in }}\n                        )\n                    {% endif %}\n\n                    {% if filter_values(\"tag\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from reporting.most_recent_course_tags\n                            where\n                                tag in (\n                                    select\n                                        replaceAll(\n                                            arrayJoin({{ filter_values(\"tag\") }}),\n                                            \'- \',\n                                            \'\'\n                                        )\n                                )\n                        )\n                    {% endif %}\n            ),\n            starts as (\n                select *\n                from video_events\n                where verb_id = \'https://w3id.org/xapi/video/verbs/played\'\n            ),\n            ends as (\n                select *\n                from video_events\n                where\n                    verb_id in (\n                        \'http://adlnet.gov/expapi/verbs/completed\',\n                        \'https://w3id.org/xapi/video/verbs/seeked\',\n                        \'https://w3id.org/xapi/video/verbs/paused\',\n                        \'http://adlnet.gov/expapi/verbs/terminated\'\n                    )\n            ),\n            segments as (\n                select\n                    starts.org as org,\n                    starts.course_key as course_key,\n                    starts.video_id as video_id,\n                    starts.actor_id,\n                    starts.object_id as object_id,\n                    cast(starts.video_position as Int32) as start_position,\n                    cast(ends.video_position as Int32) as end_position,\n                    starts.emission_time as started_at,\n                    ends.emission_time as ended_at,\n                    ends.verb_id as end_type,\n                    starts.video_duration as video_duration\n                from starts left\n                asof join\n                    ends\n                    on (\n                        starts.org = ends.org\n                        and starts.course_key = ends.course_key\n                        and starts.video_id = ends.video_id\n                        and starts.actor_id = ends.actor_id\n                        and starts.emission_time < ends.emission_time\n                    )\n            ),\n            enriched_segments as (\n                select\n                    segments.org as org,\n                    segments.course_key as course_key,\n                    blocks.course_name as course_name,\n                    blocks.course_run as course_run,\n                    blocks.section_with_name as section_with_name,\n                    blocks.subsection_with_name as subsection_with_name,\n                    blocks.block_name as video_name,\n                    blocks.display_name_with_location as video_name_with_location,\n                    segments.actor_id as actor_id,\n                    segments.object_id as object_id,\n                    segments.started_at as started_at,\n                    segments.start_position\n                    - (segments.start_position % 5) as start_position,\n                    segments.end_position - (segments.end_position % 5) as end_position,\n                    segments.video_duration as video_duration,\n                    segments.video_id as video_id\n                from segments\n                join\n                    reporting.dim_course_blocks_extended blocks\n                    on (\n                        segments.course_key = blocks.course_key\n                        and segments.video_id = blocks.block_id\n                    )\n                where\n                    1 = 1\n                    {% if filter_values(\"org\") != [] %}\n                        and org in {{ filter_values(\"org\") | where_in }}\n                    {% endif %}\n\n                    {% if filter_values(\"course_name\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from event_sink.course_names\n                            where\n                                course_name\n                                in {{ filter_values(\"course_name\") | where_in }}\n                        )\n                    {% endif %}\n\n                    {% if filter_values(\"tag\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from reporting.most_recent_course_tags\n                            where\n                                tag in (\n                                    select\n                                        replaceAll(\n                                            arrayJoin({{ filter_values(\"tag\") }}),\n                                            \'- \',\n                                            \'\'\n                                        )\n                                )\n                        )\n                    {% endif %}\n            )\n\n        select\n            org,\n            course_key,\n            course_name,\n            course_run,\n            section_with_name,\n            subsection_with_name,\n            video_name,\n            video_name_with_location,\n            video_id,\n            concat(\n                \'<a href=\"\',\n                object_id,\n                \'\" target=\"_blank\">\',\n                video_name_with_location,\n                \'</a>\'\n            ) as video_link,\n            actor_id,\n            started_at,\n            arrayJoin(range(start_position, end_position, 5)) as segment_start,\n            video_duration,\n            CONCAT(\n                toString(segment_start), \'-\', toString(segment_start + 4)\n            ) as segment_range,\n            start_position,\n            username,\n            name,\n            email\n        from enriched_segments\n        left outer join\n            reporting.dim_user_pii users\n            on (actor_id like \'mailto:%\' and SUBSTRING(actor_id, 8) = users.email)\n            or actor_id = toString(users.external_user_id)\n        order by segment_start\n    )\n\nselect\n    org,\n    course_key,\n    course_name,\n    course_run,\n    section_with_name,\n    subsection_with_name,\n    video_name,\n    video_name_with_location,\n    video_link,\n    actor_id,\n    username,\n    email,\n    name,\n    count(distinct segment_start) as watched_segment_count,\n    (video_duration - 10) / 5 as video_segment_count,\n    video_segment_count <= watched_segment_count as watched_entire_video\nfrom watched_segments\nwhere\n    1 = 1\n\n    {% if filter_values(\"Section Name\") != [] %}\n        and section_with_name in {{ filter_values(\"Section Name\") | where_in }}\n    {% endif %}\n    {% if filter_values(\"Subsection Name\") != [] %}\n        and subsection_with_name in {{ filter_values(\"Subsection Name\") | where_in }}\n    {% endif %}\n    {% if from_dttm %} and started_at > \'{{ from_dttm }}\' {% endif %}\n    {% if to_dttm %} and started_at < \'{{ to_dttm }}\' {% endif %}\n\ngroup by\n    org,\n    course_key,\n    course_name,\n    course_run,\n    section_with_name,\n    subsection_with_name,\n    video_name,\n    video_name_with_location,\n    video_link,\n    actor_id,\n    video_id,\n    video_segment_count,\n    username,\n    email,\n    name\n',NULL,'[OpenedX Clickhouse].[fact_video_watches_tr_TR](id:425)',0,NULL,0,NULL,'[OpenedX Clickhouse].[reporting]','{}',_binary '\Ï\òÄ°h\÷_”=¥bM¯A\Æ',0,NULL,