    1 = 1\n                    {% if filter_values(\"org\") != [] %}\n                        and org in {{ filter_values(\"org\") | where_in }}\n                    {% endif %}\n\n                    {% if filter_values(\"course_name\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from event_sink.course_names\n                            where\n                                course_name\n                                in {{ filter_values(\"course_name\") | where_in }}\n                        )\n                    {% endif %}\n\n                    {% if filter_values(\"tag\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from reporting.most_recent_course_tags\n                            where\n                                tag in (\n                                    select\n                                        replaceAll(\n                                            arrayJoin({{ filter_values(\"tag\") }}),\n                                            \'- \',\n                                            \'\'\n                                        )\n                                )\n                        )\n                    {% endif %}\n                    and emission_time < subtractDays(now(), 7)\n                group by org, course_key, actor_id\n            )\n\n        select org, course_key, learners.actor_id as actor_id\n        from reporting.fact_student_status learners\n        join page_visits using (org, course_key, actor_id)\n        where\n            approving_state = \'failed\' and enrollment_status = \'registered\'\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                        )\n                )\n            {% endif %}\n    ) as at_risk_learners\n    on (\n        pe.org = at_risk_learners.org\n        and pe.course_key = at_risk_learners.course_key\n        and pe.actor_id = at_risk_learners.actor_id\n    )\n',NULL,'[OpenedX Clickhouse].[fact_at_risk_problem_engagement_ar](id:190)',0,NULL,0,'{}','[OpenedX Clickhouse].[reporting]',NULL,_binary '’Øiﬁ™iY¨Ñ{´\ZCU\‘',0,NULL,1,0),('2025-01-10 06:45:04','2025-01-14 07:52:42',191,'fact_at_risk_video_watches',NULL,NULL,1,1,1,0,NULL,0,NULL,'reporting','with\n    watches as (\n        with\n            watched_segments as (\n                with\n                    video_events as (\n                        select\n                            emission_time,\n                            org,\n                            course_key,\n                            splitByString(\'/xblock/\', object_id)[-1] as video_id,\n                            object_id,\n                            actor_id,\n                            verb_id,\n                            video_position,\n                            video_duration\n                        from xapi.video_playback_events\n                        where\n                            1 = 1\n                            {% if filter_values(\"org\") != [] %}\n                                and org in {{ filter_values(\"org\") | where_in }}\n                            {% endif %}\n\n                            {% if filter_values(\"course_name\") != [] %}\n                                and course_key in (\n                                    select course_key\n                                    from event_sink.course_names\n                                    where\n                                        course_name\n                                        in {{ filter_values(\"course_name\") | where_in }}\n                                )\n                            {% endif %}\n\n                            {% if filter_values(\"tag\") != [] %}\n                                and course_key in (\n                                    select course_key\n                                    from reporting.most_recent_course_tags\n                                    where\n                                        tag in (\n                                            select\n                                                replaceAll(\n                                                    arrayJoin(\n                                                        {{ filter_values(\"tag\") }}\n                                                    ),\n                                                    \'- \',\n                                                    \'\'\n                                                )\n                                        )\n                                )\n                            {% endif %}\n                    ),\n                    starts as (\n                        select *\n                        from video_events\n                        where verb_id = \'https://w3id.org/xapi/video/verbs/played\'\n                    ),\n                    ends as (\n                        select *\n                        from video_events\n                        where\n                            verb_id in (\n                                \'http://adlnet.gov/expapi/verbs/completed\',\n                                \'https://w3id.org/xapi/video/verbs/seeked\',\n                                \'https://w3id.org/xapi/video/verbs/paused\',\n                                \'http://adlnet.gov/expapi/verbs/terminated\'\n                            )\n                    ),\n                    segments as (\n                        select\n                            starts.org as org,\n                            starts.course_key as course_key,\n                            starts.video_id as video_id,\n                            starts.actor_id,\n                            starts.object_id as object_id,\n                            cast(starts.video_position as Int32) as start_position,\n                            cast(ends.video_position as Int32) as end_position,\n                            starts.emission_time as started_at,\n                            ends.emission_time as ended_at,\n                            ends.verb_id as end_type,\n                            starts.video_duration as video_duration\n                        from starts left\n                        asof join\n                            ends\n                            on (\n                                starts.org = ends.org\n                                and starts.course_key = ends.course_key\n                                and starts.video_id = ends.video_id\n                                and starts.actor_id = ends.actor_id\n                                and starts.emission_time < ends.emission_time\n                            )\n                    ),\n                    enriched_segments as (\n                        select\n                            segments.org as org,\n                            segments.course_key as course_key,\n                            blocks.course_name as course_name,\n                            blocks.course_run as course_run,\n                            blocks.section_with_name as section_with_name,\n                            blocks.subsection_with_name as subsection_with_name,\n                            blocks.block_name as video_name,\n                            blocks.display_name_with_location\n                            as video_name_with_location,\n                            segments.actor_id as actor_id,\n                            segments.object_id as object_id,\n                            segments.started_at as started_at,\n                            segments.start_position\n                            - (segments.start_position % 5) as start_position,\n                            segments.end_position\n                            - (segments.end_position % 5) as end_position,\n                            segments.video_duration as video_duration,\n                            segments.video_id as video_id\n                        from segments\n                        join\n                            reporting.dim_course_blocks_extended blocks\n                            on (\n                                segments.course_key = blocks.course_key\n                                and segments.video_id = blocks.block_id\n                            )\n                        where\n                            1 = 1\n                            {% if filter_values(\"org\") != [] %}\n                                and org in {{ filter_values(\"org\") | where_in }}\n                            {% endif %}\n\n                            {% if filter_values(\"course_name\") != [] %}\n                                and course_key in (\n                                    select course_key\n                                    from event_sink.course_names\n                                    where\n                                        course_name\n                                        in {{ filter_values(\"course_name\") | where_in }}\n                                )\n                            {% endif %}\n\n                            {% if filter_values(\"tag\") != [] %}\n                                and course_key in (\n                                    select course_key\n                                    from reporting.most_recent_course_tags\n                                    where\n                                        tag in (\n                                            select\n                                                replaceAll(\n                                                    arrayJoin(\n                                                        {{ filter_values(\"tag\") }}\n                                                    ),\n                                                    \'- \',\n                                                    \'\'\n                                                )\n                                        )\n                                )\n                            {% endif %}\n                    )\n\n                select\n                    org,\n                    course_key,\n                    course_name,\n                    course_run,\n                    section_with_name,\n                    subsection_with_name,\n                    video_name,\n                    video_name_with_location,\n                    video_id,\n                    concat(\n                        \'<a href=\"\',\n                        object_id,\n                        \'\" target=\"_blank\">\',\n                        video_name_with_location,\n                        \'</a>\'\n                    ) as video_link,\n                    actor_id,\n                    started_at,\n                    arrayJoin(range(start_position, end_position, 5)) as segment_start,\n                    video_duration,\n                    CONCAT(\n                        toString(segment_start), \'-\', toString(segment_start + 4)\n                    ) as segment_range,\n                    start_position,\n                    username,\n                    name,\n                    email\n                from enriched_segments\n                left outer join\n                    reporting.dim_user_pii users\n                    on (\n                        actor_id like \'mailto:%\'\n                        and SUBSTRING(actor_id, 8) = users.email\n                    )\n                    or actor_id = toString(users.external_user_id)\n                order by segment_start\n            )\n\n        select\n            org,\n            course_key,\n            course_name,\n            course_run,\n            section_with_name,\n            subsection_with_name,\n            video_name,\n            video_name_with_location,\n            video_link,\n            actor_id,\n            username,\n            email,\n            name,\n            count(distinct segment_start) as watched_segment_count,\n            (video_duration - 10) / 5 as video_segment_count,\n            video_segment_count <= watched_segment_count as watched_entire_video\n        from watched_segments\n        where\n            1 = 1\n\n            {% if filter_values(\"Section Name\") != [] %}\n                and section_with_name in {{ filter_values(\"Section Name\") | where_in }}\n            {% endif %}\n            {% if filter_values(\"Subsection Name\") != [] %}\n                and subsection_with_name\n                in {{ filter_values(\"Subsection Name\") | where_in }}\n            {% endif %}\n            {% if from_dttm %} and started_at > \'{{ from_dttm }}\' {% endif %}\n            {% if to_dttm %} and started_at < \'{{ to_dttm }}\' {% endif %}\n\n        group by\n            org,\n            course_key,\n            course_name,\n            course_run,\n            section_with_name,\n            subsection_with_name,\n            video_name,\n            video_name_with_location,\n            video_link,\n            actor_id,\n            video_id,\n            video_segment_count,\n            username,\n            email,\n            name\n    )\n\nselect watches.*\nfrom watches\njoin\n    (\n        with\n            page_visits as (\n                select org, course_key, actor_id, max(emission_time) as last_visited\n                from xapi.fact_learner_last_course_visit\n                where\n                    1 = 1\n                    {% if filter_values(\"org\") != [] %}\n                        and org in {{ filter_values(\"org\") | where_in }}\n                    {% endif %}\n\n                    {% if filter_values(\"course_name\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from event_sink.course_names\n                            where\n                                course_name\n                                in {{ filter_values(\"course_name\") | where_in }}\n                        )\n                    {% endif %}\n\n                    {% if filter_values(\"tag\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from reporting.most_recent_course_tags\n                            where\n                                tag in (\n                                    select\n                                        replaceAll(\n                                            arrayJoin({{ filter_values(\"tag\") }}),\n                                            \'- \',\n                                            \'\'\n                                        )\n                                )\n                        )\n                    {% endif %}\n                    and emission_time < subtractDays(now(), 7)\n                group by org, course_key, actor_id\n            )\n\n        select org, course_key, learners.actor_id as actor_id\n        from reporting.fact_student_status learners\n        join page_visits using (org, course_key, actor_id)\n        where\n            approving_state = \'failed\' and enrollment_status = \'registered\'\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                        )\n                )\n            {% endif %}\n    ) as at_risk_learners using (org, course_key, actor_id)\nwhere\n    1 = 1\n    {% if filter_values(\"org\") != [] %}\n        and org in {{ filter_values(\"org\") | where_in }}\n    {% endif %}\n\n    {% if filter_values(\"course_name\") != [] %}\n        and course_key in (\n            select course_key\n            from event_sink.course_names\n            where course_name in {{ filter_values(\"course_name\") | where_in }}\n        )\n    {% endif %}\n\n    {% if filter_values(\"tag\") != [] %}\n        and course_key in (\n            select course_key\n            from reporting.most_recent_course_tags\n            where\n                tag\n                in (select replaceAll(arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'))\n        )\n    {% endif %}\n',NULL,'[OpenedX Clickhouse].[fact_at_risk_video_watches](id:191)',0,NULL,0,NULL,'[OpenedX Clickhouse].[reporting]','{}',_binary '¥\"Ω˛ªAëàç–Éòx˚1',0,NULL,1,0),('2025-01-10 06:45:04','2025-01-14 07:52:43',192,'fact_at_risk_video_engagement_id',NULL,NULL,1,1,1,0,NULL,0,NULL,'reporting','select fact_video_engagement.*\nfrom reporting.fact_video_engagement\njoin\n    (\n        with\n            page_visits as (\n                select org, course_key, actor_id, max(emission_time) as last_visited\n                from xapi.fact_learner_last_course_visit\n                where\n                    1 = 1\n                    {% if filter_values(\"org\") != [] %}\n                        and org in {{ filter_values(\"org\") | where_in }}\n                    {% endif %}\n\n                    {% if filter_values(\"course_name\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from event_sink.course_names\n                            where\n                                course_name\n                                in {{ filter_values(\"course_name\") | where_in }}\n                        )\n                    {% endif %}\n\n                    {% if filter_values(\"tag\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from reporting.most_recent_course_tags\n                            where\n                                tag in (\n                                    select\n                                        replaceAll(\n                                            arrayJoin({{ filter_values(\"tag\") }}),\n                                            \'- \',\n                                            \'\'\n                                        )\n                                )\n                        )\n                    {% endif %}\n                    and emission_time < subtractDays(now(), 7)\n                group by org, course_key, actor_id\n            )\n\n        select org, course_key, learners.actor_id as actor_id\n        from reporting.fact_student_status learners\n        join page_visits using (org, course_key, actor_id)\n        where\n            approving_state = \'failed\' and enrollment_status = \'registered\'\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                        )\n                )\n            {% endif %}\n    ) as at_risk_learners using (org, course_key, actor_id)\nwhere\n    1 = 1\n    {% if filter_values(\"org\") != [] %}\n        and org in {{ filter_values(\"org\") | where_in }}\n    {% endif %}\n\n    {% if filter_values(\"course_name\") != [] %}\n        and course_key in (\n            select course_key\n            from event_sink.course_names\n            where course_name in {{ filter_values(\"course_name\") | where_in }}\n        )\n    {% endif %}\n\n    {% if filter_values(\"tag\") != [] %}\n        and course_key in (\n            select course_key\n            from reporting.most_recent_course_tags\n            where\n                tag\n                in (select replaceAll(arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'))\n        )\n    {% endif %}\n',NULL,'[OpenedX Clickhouse].[fact_at_risk_video_engagement_id](id:192)',0,NULL,0,'{}','[OpenedX Clickhouse].[reporting]',NULL,_binary 'èê\ﬁ\ÁhV¥ñ\'çû\·^|\ ',0,NULL,1,0),('2025-01-10 06:45:04','2025-01-14 07:52:43',193,'superset_action_log_pt_BR',NULL,NULL,2,1,1,0,NULL,0,NULL,'superset','select\n    l.dttm as action_date,\n    case\n        when LOWER(l.action) = \'queries\'\n        then \'query from sqllab\'\n        when LOWER(l.action) = \'chartrestapi.data\'\n        then \'query from charts\'\n        when LOWER(l.action) = \'count\'\n        then \'dashboard view\'\n        when LOWER(l.action) like \'annotation%\'\n        then \'annotations\'\n        when LOWER(l.action) like \'css%\'\n        then \'CSS\'\n        else LOWER(l.action)\n    end as action,\n    l.user_id,\n    u.username as user_name,\n    u.created_on as user_registration_date,\n    l.dashboard_id,\n    d.dashboard_title,\n    case when d.published = TRUE then \'published\' else \'draft\' end as dashboard_status,\n    l.slice_id,\n    s.slice_name,\n    s.datasource_type,\n    s.datasource_name,\n    s.datasource_id,\n    COUNT(1) as action_count\nfrom logs as l\nleft join ab_user as u on u.id = l.user_id\nleft join dashboards as d on d.id = l.dashboard_id\nleft join slices as s on s.id = l.slice_id\nwhere 1 = 1 and l.action != \'log\'\ngroup by 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13\n',NULL,'[Superset Metadata].[superset_action_log_pt_BR](id:193)',0,NULL,0,NULL,'[Superset Metadata].[superset]','{}',_binary 'π†t¿\0wVãûs]86\ﬂ8',0,NULL,0,0),('2025-01-10 06:45:04','2025-01-14 07:52:43',194,'fact_video_watches_id',NULL,NULL,1,1,1,0,NULL,0,NULL,'reporting','with\n    watched_segments as (\n        with\n            video_events as (\n                select\n                    emission_time,\n                    org,\n                    course_key,\n                    splitByString(\'/xblock/\', object_id)[-1] as video_id,\n                    object_id,\n                    actor_id,\n                    verb_id,\n                    video_position,\n                    video_duration\n                from xapi.video_playback_events\n                where\n                    1 = 1\n                    {% if filter_values(\"org\") != [] %}\n                        and org in {{ filter_values(\"org\") | where_in }}\n                    {% endif %}\n\n                    {% if filter_values(\"course_name\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from event_sink.course_names\n                            where\n                                course_name\n                                in {{ filter_values(\"course_name\") | where_in }}\n                        )\n                    {% endif %}\n\n                    {% if filter_values(\"tag\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from reporting.most_recent_course_tags\n                            where\n                                tag in (\n                                    select\n                                        replaceAll(\n                                            arrayJoin({{ filter_values(\"tag\") }}),\n                                            \'- \',\n                                            \'\'\n                                        )\n                                )\n                        )\n                    {% endif %}\n            ),\n            starts as (\n                select *\n                from video_events\n                where verb_id = \'https://w3id.org/xapi/video/verbs/played\'\n            ),\n            ends as (\n                select *\n                from video_events\n                where\n                    verb_id in (\n                        \'http://adlnet.gov/expapi/verbs/completed\',\n                        \'https://w3id.org/xapi/video/verbs/seeked\',\n                        \'https://w3id.org/xapi/video/verbs/paused\',\n                        \'http://adlnet.gov/expapi/verbs/terminated\'\n                    )\n            ),\n            segments as (\n                select\n                    starts.org as org,\n                    starts.course_key as course_key,\n                    starts.video_id as video_id,\n                    starts.actor_id,\n                    starts.object_id as object_id,\n                    cast(starts.video_position as Int32) as start_position,\n                    cast(ends.video_position as Int32) as end_position,\n                    starts.emission_time as started_at,\n                    ends.emission_time as ended_at,\n                    ends.verb_id as end_type,\n                    starts.video_duration as video_duration\n                from starts left\n                asof join\n                    ends\n                    on (\n                        starts.org = ends.org\n                        and starts.course_key = ends.course_key\n                        and starts.video_id = ends.video_id\n                        and starts.actor_id = ends.actor_id\n                        and starts.emission_time < ends.emission_time\n                    )\n            ),\n            enriched_segments as (\n                select\n                    segments.org as org,\n                    segments.course_key as course_key,\n                    blocks.course_name as course_name,\n                    blocks.course_run as course_run,\n                    blocks.section_with_name as section_with_name,\n                    blocks.subsection_with_name as subsection_with_name,\n                    blocks.block_name as video_name,\n                    blocks.display_name_with_location as video_name_with_location,\n                    segments.actor_id as actor_id,\n                    segments.object_id as object_id,\n                    segments.started_at as started_at,\n                    segments.start_position\n                    - (segments.start_position % 5) as start_position,\n                    segments.end_position - (segments.end_position % 5) as end_position,\n                    segments.video_duration as video_duration,\n                    segments.video_id as video_id\n                from segments\n                join\n                    reporting.dim_course_blocks_extended blocks\n                    on (\n                        segments.course_key = blocks.course_key\n                        and segments.video_id = blocks.block_id\n                    )\n                where\n                    1 = 1\n                    {% if filter_values(\"org\") != [] %}\n                        and org in {{ filter_values(\"org\") | where_in }}\n                    {% endif %}\n\n                    {% if filter_values(\"course_name\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from event_sink.course_names\n                            where\n                                course_name\n                                in {{ filter_values(\"course_name\") | where_in }}\n                        )\n                    {% endif %}\n\n                    {% if filter_values(\"tag\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from reporting.most_recent_course_tags\n                            where\n                                tag in (\n                                    select\n                                        replaceAll(\n                                            arrayJoin({{ filter_values(\"tag\") }}),\n                                            \'- \',\n                                            \'\'\n                                        )\n                                )\n                        )\n                    {% endif %}\n            )\n\n        select\n            org,\n            course_key,\n            course_name,\n            course_run,\n            section_with_name,\n            subsection_with_name,\n            video_name,\n            video_name_with_location,\n            video_id,\n            concat(\n                \'<a href=\"\',\n                object_id,\n                \'\" target=\"_blank\">\',\n                video_name_with_location,\n                \'</a>\'\n            ) as video_link,\n            actor_id,\n            started_at,\n            arrayJoin(range(start_position, end_position, 5)) as segment_start,\n            video_duration,\n            CONCAT(\n                toString(segment_start), \'-\', toString(segment_start + 4)\n            ) as segment_range,\n            start_position,\n            username,\n            name,\n            email\n        from enriched_segments\n        left outer join\n            reporting.dim_user_pii users\n            on (actor_id like \'mailto:%\' and SUBSTRING(actor_id, 8) = users.email)\n            or actor_id = toString(users.external_user_id)\n        order by segment_start\n    )\n\nselect\n    org,\n    course_key,\n    course_name,\n    course_run,\n    section_with_name,\n    subsection_with_name,\n    video_name,\n    video_name_with_location,\n    video_link,\n    actor_id,\n    username,\n    email,\n    name,\n    count(distinct segment_start) as watched_segment_count,\n    (video_duration - 10) / 5 as video_segment_count,\n    video_segment_count <= watched_segment_count as watched_entire_video\nfrom watched_segments\nwhere\n    1 = 1\n\n    {% if filter_values(\"Section Name\") != [] %}\n        and section_with_name in {{ filter_values(\"Section Name\") | where_in }}\n    {% endif %}\n    {% if filter_values(\"Subsection Name\") != [] %}\n        and subsection_with_name in {{ filter_values(\"Subsection Name\") | where_in }}\n    {% endif %}\n    {% if from_dttm %} and started_at > \'{{ from_dttm }}\' {% endif %}\n    {% if to_dttm %} and started_at < \'{{ to_dttm }}\' {% endif %}\n\ngroup by\n    org,\n    course_key,\n    course_name,\n    course_run,\n    section_with_name,\n    subsection_with_name,\n    video_name,\n    video_name_with_location,\n    video_link,\n    actor_id,\n    video_id,\n    video_segment_count,\n    username,\n    email,\n    name\n',NULL,'[OpenedX Clickhouse].[fact_video_watches_id](id:194)',0,NULL,0,NULL,'[OpenedX Clickhouse].[reporting]','{}',_binary 'o^UAÄ\€\·A´_…Ä',0,NULL,1,0),('2025-01-10 06:45:04','2025-01-14 07:52:43',195,'fact_student_status_plus_7_days_it_IT','enrolled_at',NULL,1,1,1,0,NULL,0,NULL,NULL,'with\n    recent_activity as (\n        select course_key, COUNT(DISTINCT actor_id) as active_last_7_days\n        from xapi.navigation_events\n        where\n            emission_time >= NOW() - INTERVAL 7 DAY\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                        )\n                )\n            {% endif %}\n        group by course_key\n    )\n\nselect fss.*, COALESCE(ra.active_last_7_days, 0) as active_within_last_7_days\nfrom reporting.fact_student_status fss\nleft join recent_activity ra on fss.course_key = ra.course_key\nwhere\n    1 = 1\n    {% if filter_values(\"org\") != [] %}\n        and org in {{ filter_values(\"org\") | where_in }}\n    {% endif %}\n\n    {% if filter_values(\"course_name\") != [] %}\n        and course_key in (\n            select course_key\n            from event_sink.course_names\n            where course_name in {{ filter_values(\"course_name\") | where_in }}\n        )\n    {% endif %}\n\n    {% if filter_values(\"tag\") != [] %}\n        and course_key in (\n            select course_key\n            from reporting.most_recent_course_tags\n            where\n                tag\n                in (select replaceAll(arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'))\n        )\n    {% endif %}\n',NULL,'[OpenedX Clickhouse].[fact_student_status_plus_7_days_it_IT](id:195)',1,NULL,0,NULL,NULL,NULL,_binary '\0òa\Â\—qW/É#Å\„4\—',0,NULL,0,0),('2025-01-10 06:45:05','2025-01-14 07:52:43',196,'learner_summary_es_419','emission_time',NULL,1,1,1,0,NULL,0,NULL,'reporting','with\n    latest_emission_time as (\n        select org, course_key, actor_id, MAX(emission_time) as last_visited\n        from xapi.fact_learner_last_course_visit\n        where\n            1 = 1\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                        )\n                )\n            {% endif %}\n            {% if filter_values(\"username\") != [] or filter_values(\n                \"name\"\n            ) != [] or filter_values(\"email\") != [] %}\n                and actor_id in (\n                    select external_user_id::String\n                    from event_sink.user_pii\n                    where\n                        1 = 1\n                        {% if filter_values(\"username\") != [] %}\n                            and username in {{ filter_values(\"username\") | where_in }}\n                        {% endif %}\n                        {% if filter_values(\"name\") != [] %}\n                            and name in {{ filter_values(\"name\") | where_in }}\n                        {% endif %}\n                        {% if filter_values(\"email\") != [] %}\n                            and email in {{ filter_values(\"email\") | where_in }}\n                        {% endif %}\n                )\n            {% endif %}\n        group by org, course_key, actor_id\n    ),\n    enrollment_status as (\n        select org, course_key, actor_id, MAX(emission_time) as max_emission_time\n        from reporting.fact_enrollment_status\n        where\n            1 = 1\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                        )\n                )\n            {% endif %}\n            {% if filter_values(\"username\") != [] or filter_values(\n                \"name\"\n            ) != [] or filter_values(\"email\") != [] %}\n                and actor_id in (\n                    select external_user_id::String\n                    from event_sink.user_pii\n                    where\n                        1 = 1\n                        {% if filter_values(\"username\") != [] %}\n                            and username in {{ filter_values(\"username\") | where_in }}\n                        {% endif %}\n                        {% if filter_values(\"name\") != [] %}\n                            and name in {{ filter_values(\"name\") | where_in }}\n                        {% endif %}\n                        {% if filter_values(\"email\") != [] %}\n                            and email in {{ filter_values(\"email\") | where_in }}\n                        {% endif %}\n                )\n            {% endif %}\n        group by org, course_key, actor_id\n    ),\n    student_status as (\n        select\n            fss.org as org,\n            fss.course_key as course_key,\n            fss.actor_id as actor_id,\n            fss.course_name as course_name,\n            fss.course_run as course_run,\n            fss.approving_state as approving_state,\n            fss.enrollment_mode as enrollment_mode,\n            fss.enrollment_status as enrollment_status,\n            fss.course_grade as course_grade,\n            fss.grade_bucket as grade_bucket,\n            fss.username as username,\n            fss.name as name,\n            fss.email as email,\n            fss.enrolled_at as enrolled_at\n        from reporting.fact_student_status fss\n        where\n            1 = 1\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                        )\n                )\n            {% endif %}\n            {% if filter_values(\"username\") != [] or filter_values(\n                \"name\"\n            ) != [] or filter_values(\"email\") != [] %}\n                and actor_id in (\n                    select external_user_id::String\n                    from event_sink.user_pii\n                    where\n                        1 = 1\n                        {% if filter_values(\"username\") != [] %}\n                            and username in {{ filter_values(\"username\") | where_in }}\n                        {% endif %}\n                        {% if filter_values(\"name\") != [] %}\n                            and name in {{ filter_values(\"name\") | where_in }}\n                        {% endif %}\n                        {% if filter_values(\"email\") != [] %}\n                            and email in {{ filter_values(\"email\") | where_in }}\n                        {% endif %}\n                )\n            {% endif %}\n    )\nselect\n    fss.org as org,\n    fss.course_key as course_key,\n    fss.actor_id as actor_id,\n    fss.course_name as course_name,\n    fss.course_run as course_run,\n    fss.approving_state as approving_state,\n    fss.enrollment_mode as enrollment_mode,\n    fss.enrollment_status as enrollment_status,\n    fss.course_grade as course_grade,\n    fss.grade_bucket as grade_bucket,\n    fss.username as username,\n    fss.name as name,\n    fss.email as email,\n    fes.max_emission_time as emission_time,\n    GREATEST(let.last_visited, fss.enrolled_at) as last_visited\nfrom student_status fss\nleft join\n    enrollment_status fes\n    on fss.org = fes.org\n    and fss.course_key = fes.course_key\n    and fss.actor_id = fes.actor_id\nleft join\n    latest_emission_time let\n    on fss.org = let.org\n    and fss.course_key = let.course_key\n    and fss.actor_id = let.actor_id\nwhere\n    1 = 1\n    {% if filter_values(\"org\") != [] %}\n        and org in {{ filter_values(\"org\") | where_in }}\n    {% endif %}\n\n    {% if filter_values(\"course_name\") != [] %}\n        and course_key in (\n            select course_key\n            from event_sink.course_names\n            where course_name in {{ filter_values(\"course_name\") | where_in }}\n        )\n    {% endif %}\n\n    {% if filter_values(\"tag\") != [] %}\n        and course_key in (\n            select course_key\n            from reporting.most_recent_course_tags\n            where\n                tag\n                in (select replaceAll(arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'))\n        )\n    {% endif %}\n',NULL,'[OpenedX Clickhouse].[learner_summary_es_419](id:196)',1,NULL,0,NULL,'[OpenedX Clickhouse].[reporting]',NULL,_binary '\n\nd\◊uZ\Êôl∏\…\’\\µ\Ò',0,NULL,0,0),('2025-01-10 06:45:05','2025-01-14 07:52:43',197,'fact_at_risk_video_engagement_it_IT',NULL,NULL,1,1,1,0,NULL,0,NULL,'reporting','select fact_video_engagement.*\nfrom reporting.fact_video_engagement\njoin\n    (\n        with\n            page_visits as (\n                select org, course_key, actor_id, max(emission_time) as last_visited\n                from xapi.fact_learner_last_course_visit\n                where\n                    1 = 1\n                    {% if filter_values(\"org\") != [] %}\n                        and org in {{ filter_values(\"org\") | where_in }}\n                    {% endif %}\n\n                    {% if filter_values(\"course_name\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from event_sink.course_names\n                            where\n                                course_name\n                                in {{ filter_values(\"course_name\") | where_in }}\n                        )\n                    {% endif %}\n\n                    {% if filter_values(\"tag\") != [] %}\n                        and course_key in (\n                            select course_key\n                            from reporting.most_recent_course_tags\n                            where\n                                tag in (\n                                    select\n                                        replaceAll(\n                                            arrayJoin({{ filter_values(\"tag\") }}),\n                                            \'- \',\n                                            \'\'\n                                        )\n                                )\n                        )\n                    {% endif %}\n                    and emission_time < subtractDays(now(), 7)\n                group by org, course_key, actor_id\n            )\n\n        select org, course_key, learners.actor_id as actor_id\n        from reporting.fact_student_status learners\n        join page_visits using (org, course_key, actor_id)\n        where\n            approving_state = \'failed\' and enrollment_status = \'registered\'\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                        )\n                )\n            {% endif %}\n    ) as at_risk_learners using (org, course_key, actor_id)\nwhere\n    1 = 1\n    {% if filter_values(\"org\") != [] %}\n        and org in {{ filter_values(\"org\") | where_in }}\n    {% endif %}\n\n    {% if filter_values(\"course_name\") != [] %}\n        and course_key in (\n            select course_key\n            from event_sink.course_names\n            where course_name in {{ filter_values(\"course_name\") | where_in }}\n        )\n    {% endif %}\n\n    {% if filter_values(\"tag\") != [] %}\n        and course_key in (\n            select course_key\n            from reporting.most_recent_course_tags\n            where\n                tag\n                in (select replaceAll(arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'))\n        )\n    {% endif %}\n',NULL,'[OpenedX Clickhouse].[fact_at_risk_video_engagement_it_IT](id:197)',0,NULL,0,'{}','[OpenedX Clickhouse].[reporting]',NULL,_binary '¢≈†9Ö\ÛQ¶E?$	X\˜.',0,NULL,1,0),('2025-01-10 06:45:05','2025-01-14 07:52:43',198,'int_problem_results_es_419','emission_time',NULL,1,1,1,0,NULL,0,NULL,'reporting','-- select one record per (learner, problem, course, org) tuple\n-- contains either the first successful attempt\n-- or the most recent unsuccessful attempt\n-- find the timestamp of the earliest successful response\n-- this will be used to pick the xAPI event corresponding to that submission\nwith\n    successful_responses as (\n        select\n            org, course_key, problem_id, actor_id::String as actor_id, first_success_at\n        from xapi.responses\n        where\n            isNotNull(first_success_at)\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                        )\n                )\n            {% endif %}\n    ),\n    -- for all learners who did not submit a successful response,\n    -- find the timestamp of the most recent unsuccessful response\n    unsuccessful_responses as (\n        select\n            org,\n            course_key,\n            problem_id,\n            actor_id::String as actor_id,\n            max(last_attempt_at) as last_attempt_at\n        from xapi.responses\n        where\n            actor_id not in (select distinct actor_id from successful_responses)\n            {% if filter_values(\"org\") != [] %}\n                and org in {{ filter_values(\"org\") | where_in }}\n            {% endif %}\n\n            {% if filter_values(\"course_name\") != [] %}\n                and course_key in (\n                    select course_key\n                    from event_sink.course_names\n                    where course_name in {{ filter_values(\"course_name\") | where_in }}\n                )\n            {% endif %}\n\n            {% if filter_values(\"tag\") != [] %}\n                and course_key in (\n                    select course_key\n                    from reporting.most_recent_course_tags\n                    where\n                        tag in (\n                            select\n                                replaceAll(\n                                    arrayJoin({{ filter_values(\"tag\") }}), \'- \', \'\'\n                                )\n                  